<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apartment Details - RealEstateAI</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body data-page="apartment_information" class="bg-gray-100">

    <!-- NAVBAR -->
    <nav class="sticky top-0 z-50 bg-white shadow-md">
        <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
            <h1 class="text-3xl font-bold text-green-600">RealEstateAI</h1>
            <div class="hidden md:flex space-x-8 font-medium text-gray-700 items-center">
                <a href="index.html">Home</a>
                <a href="listings.html">Buy</a>
                <a href="contact.html">Contact</a>
                
                <!-- Notification Bell -->
                <div class="relative">
                    <button id="notificationBell" class="relative p-2 hover:bg-gray-100 rounded-full transition-colors duration-200">
                        <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                        </svg>
                        <span id="notificationBadge" class="hidden absolute top-0 right-0 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">0</span>
                    </button>
                    
                    <!-- Notification Dropdown -->
                    <div id="notificationDropdown" class="hidden absolute right-0 mt-2 w-80 bg-white rounded-lg shadow-xl border border-gray-200 max-h-96 overflow-y-auto z-50">
                        <div class="p-4 border-b border-gray-200">
                            <h3 class="font-semibold text-gray-800">New Followups</h3>
                        </div>
                        <div id="notificationList" class="divide-y divide-gray-100">
                            <!-- Notifications will be inserted here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- APARTMENT DETAILS -->
    <section class="max-w-7xl mx-auto p-6 bg-white shadow rounded mt-6">
        <img id="mainImage" class="w-full h-96 object-cover rounded shadow mb-6">
        <h1 id="propertyTitle" class="text-3xl font-bold"></h1>
        <p id="propertyPrice" class="text-green-600 text-2xl font-bold"></p>
        <p id="propertyLocation" class="text-gray-500 mt-1"></p>
        <p id="propertyDesc" class="mt-4 text-gray-700"></p>
        <div id="propertyGallery" class="grid grid-cols-3 gap-2 mt-6"></div>
    </section>

    <!-- CHATBOT TOGGLE -->
    <button id="chatbotToggle"
        class="fixed bottom-6 right-6 bg-green-600 text-white p-4 rounded-full shadow-lg text-xl z-40">
        ðŸ’¬
    </button>

    <!-- CHAT PANEL -->
    <div id="chatbotPanel"
        class="fixed top-16 right-0 h-[calc(100%-4rem)] w-96 bg-white shadow-lg translate-x-full transition duration-300 flex flex-col z-40">

        <div class="p-4 bg-green-600 text-white flex justify-between">
            <div>
                <h2 class="text-lg font-bold">RealEstateAI Assistant</h2>
                <p id="chatbotPropertyName" class="text-sm opacity-90"></p>
            </div>
            <button id="closeChat" class="text-2xl">&times;</button>
        </div>

        <div id="chatMessages" class="flex-1 p-4 overflow-y-auto bg-gray-50"></div>

        <input id="chatInput" class="border p-3 m-2 rounded focus:outline-none focus:ring-2 focus:ring-green-500"
            placeholder="Type message & press Enter">
    </div>

    <script>
        const BASE_URL = "https://api.appolyse.com";

        const propertyId = new URLSearchParams(window.location.search).get("property_id");
        const openChat = new URLSearchParams(window.location.search).get("openChat");

        let USER_ID;
        const AGENT_ID = 222;

        const chatbotPanel = document.getElementById("chatbotPanel");
        const chatMessages = document.getElementById("chatMessages");
        const chatInput = document.getElementById("chatInput");

        document.getElementById("chatbotToggle").onclick =
            () => chatbotPanel.classList.toggle("translate-x-full");
        document.getElementById("closeChat").onclick =
            () => chatbotPanel.classList.add("translate-x-full");

        function imgUrl(path) {
            return path?.startsWith("http") ? path : BASE_URL + path;
        }

        async function updateLastSeen() {
            if (!USER_ID) return;
            try {
                await fetch(`${BASE_URL}/users/${USER_ID}`, {
                    method: "PATCH",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ last_seen_at: new Date().toISOString() })
                });
            } catch (err) { console.error("Failed to update last_seen_at:", err); }
        }

        async function initUser() {
            USER_ID = localStorage.getItem("user_id");
            if (!USER_ID) {
                const res = await fetch(`${BASE_URL}/users`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        name: "Guest User",
                        email: "guest_" + Date.now() + "@guest.com",
                        role: "user"
                    })
                });
                const user = await res.json();
                USER_ID = user.id;
                localStorage.setItem("user_id", USER_ID);
            }

            startApp();
            updateLastSeen();
            setInterval(updateLastSeen, 2 * 60 * 1000);
        }

        async function startApp() {
            // Start chat session
            await fetch(`${BASE_URL}/chat/start`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ sender_id: USER_ID, receiver_id: AGENT_ID, property_id: propertyId })
            });

            await loadApartment();
            await loadChat();
            setInterval(loadChat, 5000);

            // Auto-open chat if coming from notification
            if (openChat === 'true') {
                chatbotPanel.classList.remove("translate-x-full");
            }

            chatInput.addEventListener("keydown", async e => {
                if (e.key !== "Enter" || !chatInput.value.trim()) return;

                const messageText = chatInput.value.trim();
                chatInput.value = "";
                chatInput.disabled = true;

                try {
                    const sendRes = await fetch(`${BASE_URL}/chat/send`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ sender_id: USER_ID, receiver_id: AGENT_ID, property_id: propertyId, message: messageText })
                    });
                    
                    if (!sendRes.ok) {
                        throw new Error(`Failed to send message: ${sendRes.status}`);
                    }
                    
                    console.log("Message sent successfully");
                    
                    // Wait a bit for backend to process
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    // Reload chat to show new message
                    lastMessageCount = 0;
                    await loadChat();
                    
                    // Trigger followup generation if endpoint exists
                    try {
                        await fetch(`${BASE_URL}/chat/generate-followup`, {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ user_id: USER_ID, property_id: propertyId })
                        });
                    } catch (err) {
                        console.log("Followup endpoint not available:", err);
                    }
                    
                    updateLastSeen();
                } catch (err) {
                    console.error("Failed to send message:", err);
                    alert("Error sending message. Please try again.");
                } finally {
                    chatInput.disabled = false;
                    chatInput.focus();
                }
            });
        }

        async function loadApartment() {
            const res = await fetch(`${BASE_URL}/apartments/${propertyId}`);
            const data = await res.json();

            // Track this property interaction for notifications
            let interactions = JSON.parse(localStorage.getItem("user_property_interactions") || "[]");
            const existing = interactions.find(i => i.propertyId === propertyId);
            if (!existing) {
                interactions.push({ propertyId: propertyId, propertyType: 'apartment' });
                localStorage.setItem("user_property_interactions", JSON.stringify(interactions));
            }

            document.getElementById("propertyTitle").textContent = data.title;
            document.getElementById("propertyPrice").textContent = data.price;
            document.getElementById("propertyLocation").textContent =
                `${data.location} â€¢ ${data.beds} Bed â€¢ ${data.baths} Bath â€¢ ${data.sqft} sqft`;
            document.getElementById("propertyDesc").textContent = data.description;
            document.getElementById("mainImage").src = imgUrl(data.main_image);
            document.getElementById("chatbotPropertyName").textContent = data.title;

            const gallery = document.getElementById("propertyGallery");
            gallery.innerHTML = "";
            data.images?.split(",").forEach(img => {
                const i = document.createElement("img");
                i.src = imgUrl(img.trim());
                i.className = "h-32 w-full object-cover rounded";
                gallery.appendChild(i);
            });
        }

        let lastMessageCount = 0;
        let chatCache = [];
        
        async function loadChat() {
            if (!USER_ID) return;
            try {
                const res = await fetch(`${BASE_URL}/chat/conversation/${USER_ID}/${AGENT_ID}/${propertyId}`);
                if (!res.ok) return;
                const dailyChats = await res.json();
                
                // Flatten all messages with their day info
                const allMessages = [];
                dailyChats.forEach(dayConv => {
                    (dayConv.messages || []).forEach(msg => {
                        allMessages.push({ ...msg, conversation_date: dayConv.conversation_date });
                    });
                });
                
                // If no new messages, return early
                if (allMessages.length === lastMessageCount && chatCache.length === allMessages.length) {
                    return;
                }
                
                // Clear and rebuild only if we have new messages
                if (allMessages.length > lastMessageCount) {
                    chatMessages.innerHTML = "";
                    lastMessageCount = allMessages.length;
                    chatCache = allMessages;
                    
                    let currentDate = null;
                    allMessages.forEach(msg => {
                        // Add date separator if date changed
                        if (msg.conversation_date !== currentDate) {
                            currentDate = msg.conversation_date;
                            const dateDiv = document.createElement("div");
                            dateDiv.className = "text-center text-gray-400 text-sm my-2";
                            dateDiv.textContent = new Date(msg.conversation_date).toLocaleDateString();
                            chatMessages.appendChild(dateDiv);
                        }
                        
                        const isUser = msg.sender_id == USER_ID;
                        const isAI = msg.type === "ai_followup";
                        const timeStr = msg.time ? new Date(msg.time).toLocaleTimeString('en-US', {
                            hour: '2-digit',
                            minute: '2-digit'
                        }) : '';
                        
                        const div = document.createElement("div");
                        div.className = `mb-2 flex ${isUser ? "justify-end" : "justify-start"}`;
                        div.innerHTML = `<div class="flex flex-col ${isUser ? 'items-end' : 'items-start'}">
                            <span class="inline-block px-3 py-2 rounded text-sm ${isUser ? "bg-green-100" : isAI ? "bg-purple-100 italic" : "bg-gray-200"}">${msg.message}</span>
                            <span class="text-xs text-gray-400 mt-1 px-1">${timeStr}</span>
                        </div>`;
                        chatMessages.appendChild(div);
                    });
                    
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            } catch (err) { console.error("Failed to load chat:", err); }
        }

        initUser();
    </script>

    <script src="js/tracking.js"></script>
    <script src="js/notifications.js"></script>
    <script>
        // Notification bell toggle
        const notificationBell = document.getElementById("notificationBell");
        const notificationDropdown = document.getElementById("notificationDropdown");
        
        if (notificationBell) {
            notificationBell.addEventListener("click", (e) => {
                e.stopPropagation();
                notificationDropdown.classList.toggle("hidden");
            });

            document.addEventListener("click", () => {
                notificationDropdown.classList.add("hidden");
            });

            notificationDropdown.addEventListener("click", (e) => {
                e.stopPropagation();
            });
        }
    </script>
</body>

</html>